<style>
  /* ====== BRAND / THEME VARS ====== */
  :root{
    --pba-aura-color:#7C3AED;   /* active companion aura (overwritten by [data-theme]) */
    --pba-accent:#7C3AED;       /* buttons & accents */
    --pba-user-bg:#E6F6EE;      /* user bubble bg (pale mint green) */
    --pba-user-avatar:url('https://kajabi-storefronts-production.kajabi-cdn.com/kajabi-storefronts-production/file-uploads/themes/2148578038/settings_images/d7dbf5c-161d-e0b0-42e0-e0cc2c7512_8123a4fd-c37b-415b-bbf6-ccc2b515fa88.png');           /* personal/marketing default (LinkedIn) */
    --pba-user-avatar-public:url('https://kajabi-storefronts-production.kajabi-cdn.com/kajabi-storefronts-production/file-uploads/themes/2148578038/settings_images/26b54f5-e37a-533c-87-6cee4bb67bf_PBA_Favicon_temp_2.png'); /* public/free (favicon) */
    --pba-tooltip-bg:#111827;
    --pba-tooltip-fg:#fff;
  }
  [data-theme="astra"]  { --pba-aura-color:#7C3AED; --pba-accent:#7C3AED; }
  [data-theme="lumina"] { --pba-aura-color:#FFD700; --pba-accent:#FFD700; }
  [data-theme="paxion"] { --pba-aura-color:#38BDF8; --pba-accent:#38BDF8; }
  [data-theme="impaxis"]{ --pba-aura-color:#22C55E; --pba-accent:#22C55E; }

  /* ====== FONTS ====== */
  .pba-chat, .pba-dock, .pba-switcher, .pba-tooltip {
    font-family: "Open Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  }
  .pba-chat-header, .pba-chip { font-family: "Fira Sans", "Open Sans", system-ui, sans-serif; }

  /* ===== DOCK BUTTON ===== */
  .pba-dock{position:fixed;right:16px;bottom:16px;z-index:99999;display:flex;flex-direction:column;gap:12px;align-items:flex-end;will-change: transform;}
.pba-dock:hover,
.pba-dock:active {
  animation: pbaBounce .32s ease;
}
  .pba-avatar{position:relative; isolation:isolate;}
  .pba-avatar-btn{width:64px;height:64px;border-radius:9999px;background:#fff;box-shadow:0 8px 24px rgba(0,0,0,.18);display:grid;place-items:center;cursor:pointer;transition:transform .15s ease,box-shadow .15s ease,border-color .15s ease;border:1px solid rgba(0,0,0,.06)}
  .pba-avatar-btn:hover{transform:scale(1.08);box-shadow:0 10px 28px rgba(0,0,0,.22)}
  .pba-avatar-face{width:52px;height:52px;border-radius:999px;display:grid;place-items:center;overflow:hidden}
  .pba-avatar-face img{width:52px;height:52px;object-fit:cover;border-radius:999px;transform:scale(1.25);animation:pbaBob 6s ease-in-out infinite, pbaGlow 5.5s ease-in-out infinite}
  .pba-avatar-btn{animation:pbaShadow 5.5s ease-in-out infinite}
  .pba-avatar::after{
    content:"";position:absolute;inset:-8px;border-radius:9999px;z-index:-1;
    background: radial-gradient(circle at 50% 60%, color-mix(in srgb, var(--pba-aura-color) 35%, transparent), transparent 60%) !important;
    filter: blur(8px) saturate(1.10) !important; pointer-events:none;
  }
  @keyframes pbaBob{0%,100%{transform:translateY(0)}50%{transform:translateY(-2px)}}
  @keyframes pbaGlow{0%,100%{filter:drop-shadow(0 0 0 color-mix(in srgb, var(--pba-aura-color) 0%, transparent))}50%{filter:drop-shadow(0 0 6px color-mix(in srgb, var(--pba-aura-color) 45%, transparent))}}
  @keyframes pbaShadow{0%,100%{box-shadow:0 8px 24px rgba(0,0,0,.18)}50%{box-shadow:0 12px 28px rgba(0,0,0,.22)}}
@keyframes pbaWiggle {
  0%,100% { transform: rotate(0deg) }
  15%     { transform: rotate(-6deg) }
  30%     { transform: rotate(6deg) }
  45%     { transform: rotate(-6deg) }
  60%     { transform: rotate(6deg) }
  75%     { transform: rotate(-3deg) }
  90%     { transform: rotate(3deg) }
}

@keyframes pbaStagePop {
  0%   { transform: scale(1) translateY(0); }
  55%  { transform: scale(1.34) translateY(-3px); filter: drop-shadow(0 0 28px color-mix(in srgb, var(--pba-aura-color) 60%, transparent)); }
  75%  { transform: scale(1.18) translateY(-1px); filter: drop-shadow(0 0 16px color-mix(in srgb, var(--pba-aura-color) 40%, transparent)); }
  100% { transform: scale(1) translateY(0);      filter: drop-shadow(0 0 10px color-mix(in srgb, var(--pba-aura-color) 24%, transparent)); }
}

.pba-stage.pop{
  animation: pbaStagePop .25s ease-out;
}

/* image-only pop */
.pba-stage img.pop{
  animation: pbaStagePop .22s cubic-bezier(.3,.85,.4,1);
}

  /* ===== CHAT CONTAINER ===== */
  .pba-chat{
    position:fixed;right:96px;bottom:16px;width:360px;max-width:90vw;height:520px;
    background:#fff;border-radius:16px;box-shadow:0 16px 40px rgba(0,0,0,.22);
    display:none;flex-direction:column;overflow:hidden;border:1px solid rgba(0,0,0,.06);
    z-index:100000; box-sizing:border-box;
  }
  .pba-chat-header{padding:10px 12px;font-weight:600;border-bottom:1px solid rgba(0,0,0,.06);display:flex;align-items:center;gap:10px;background:#fff}
  .pba-dot{width:8px;height:8px;border-radius:999px;background:var(--pba-accent)}
  .pba-header-spacer{flex:1}
  .pba-icon-btn{cursor:pointer;user-select:none;font-size:16px;line-height:1;padding:6px;border-radius:8px;transition:background .15s ease}
  .pba-icon-btn:hover{background:#f3f4f6}
  .pba-close{cursor:pointer;font-size:20px;line-height:1}

  /* Header buttons (default visible) */
  #pbaHamburger{display:none;} /* only in mobile landscape */
  #pbaExpandBtn,#pbaStageToggle,#pbaSwitcherBtn,#pbaPromptsToggle,#pbaClose{display:inline-block;}

  /* ===== STAGE (HERO) ===== */
  .pba-stage{height:180px;display:flex;align-items:center;justify-content:center;background:radial-gradient(circle at 50% 30%, #faf5ff 0%, #ffffff 60%);border-bottom:1px solid rgba(0,0,0,.06)}

.pba-stage img{
  width:120px;height:120px;object-fit:contain;
  animation:pbaStageBob 6s ease-in-out infinite, pbaStageGlow 5.5s ease-in-out infinite;
  filter: drop-shadow(0 0 20px color-mix(in srgb, var(--pba-aura-color) 48%, transparent));
  will-change: transform, filter;
}

  @keyframes pbaStageBob{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
  @keyframes pbaStageGlow{0%,100%{filter:drop-shadow(0 0 10px color-mix(in srgb, var(--pba-aura-color) 32%, transparent))}50%{filter:drop-shadow(0 0 20px color-mix(in srgb, var(--pba-aura-color) 48%, transparent))}}

/* Bounce LEFT variant (slower, dramatic) */
@keyframes pbaBounceLeft {
  0%   { transform: translate(0,0); }
  20%  { transform: translate(0,-40px); }    /* higher jump */
  45%  { transform: translate(-16px,0); }    /* stronger left drop */
  60%  { transform: translate(0,-22px); }    /* 1st rebound */
  75%  { transform: translate(0,0); }
  85%  { transform: translate(0,-12px); }    /* 2nd smaller hop */
  92%  { transform: translate(0,0); }
  97%  { transform: translate(0,-6px); }     /* 3rd tiny hop */
  100% { transform: translate(0,0); }
}

/* Bounce RIGHT variant (slower, dramatic) */
@keyframes pbaBounceRight {
  0%   { transform: translate(0,0); }
  20%  { transform: translate(0,-40px); }    /* higher jump */
  45%  { transform: translate(16px,0); }     /* stronger right drop */
  60%  { transform: translate(0,-22px); }    /* 1st rebound */
  75%  { transform: translate(0,0); }
  85%  { transform: translate(0,-12px); }    /* 2nd smaller hop */
  92%  { transform: translate(0,0); }
  97%  { transform: translate(0,-6px); }     /* 3rd tiny hop */
  100% { transform: translate(0,0); }
}

/* Move-away: quick nudge left/up then back */
@keyframes pbaMoveAway {
  0%   { transform: translate(0,0) }
  35%  { transform: translate(-22px,-6px) }  /* sharp dodge left/up */
  70%  { transform: translate(10px,0) }      /* rebound right */
  100% { transform: translate(0,0) }
}

/* Move-away RIGHT variant */
@keyframes pbaMoveAwayRight {
  0%   { transform: translate(0,0) }
  35%  { transform: translate(22px,-8px) }   /* sharper dodge right/up */
  70%  { transform: translate(-12px,0) }     /* rebound left */
  100% { transform: translate(0,0) }
}

/* Sparkle burst particles (firework style) */
.pba-sparkle{
  position:absolute;
  width:14px; height:14px;      /* bigger */
  border-radius:50%;
  pointer-events:none;
  background: radial-gradient(circle, #fff 40%, var(--pba-aura-color) 100%); /* bright core */
  box-shadow: 0 0 8px var(--pba-aura-color), 0 0 16px var(--pba-aura-color); /* glow */
  animation:pbaSparkle 1.2s ease-out forwards; /* longer */
}

@keyframes pbaSparkle {
  0%   { transform:scale(0.4) translate(0,0); opacity:1; }
  30%  { transform:scale(1.4) translate(var(--dx),var(--dy)); opacity:.95; }
  55%  { transform:scale(1.0) translate(var(--dx),var(--dy)); opacity:.55; } /* slight collapse */
  65%  { opacity:.9; }   /* twinkle up */
  85%  { opacity:.45; }  /* twinkle down */
  100% { transform:scale(0.5) translate(var(--dx),var(--dy)); opacity:0; }
}

/* utility class to trigger move-away */
.pba-move{ animation: pbaMoveAway .36s ease; }

/* utility class to trigger bounce on demand */
.pba-bounce{ animation: pbaBounce .32s ease; }

  /* ===== STARTER PROMPTS ===== */
 .pba-prompts{
  display:flex; gap:8px; flex-wrap:wrap;
  padding:8px 12px 0;
  padding-left:16px; /* anti-clip */
}
  .pba-prompts.hidden{ display:none; }
  .pba-chip{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(0,0,0,.12); background:#fff; cursor:pointer; position:relative; }
  .pba-chip:hover{ background:#f5f5f5; }

  /* Tooltip (desktop hover) */
  .pba-chip[data-tooltip]:hover::after{
    content: attr(data-tooltip);
    position:absolute; left:50%; transform:translateX(-50%); bottom: calc(100% + 8px);
    white-space: nowrap; font-size:12px; padding:6px 8px; border-radius:6px;
    background: var(--pba-tooltip-bg); color: var(--pba-tooltip-fg);
    box-shadow:0 6px 16px rgba(0,0,0,.2); z-index:3;
  }
  .pba-chip[data-tooltip]:hover::before{
    content:""; position:absolute; left:50%; transform:translateX(-50%); bottom: calc(100% + 4px);
    border:6px solid transparent; border-top-color: var(--pba-tooltip-bg);
  }

  /* Mobile helper blurb (first-time per companion) */
  .pba-chip .pba-helper{
  position:absolute;
  left:96px;   /* shift ~1 inch to the right */
  top: calc(100% + 4px);
  background:#27AE60;
  color:#fff;
  font-size:11px;
  line-height:1.2;
  padding:6px 8px;
  border-radius:6px;
  white-space:nowrap;
  box-shadow:0 6px 16px rgba(0,0,0,.2);
  opacity:0;
  pointer-events:none;
  transition:opacity .18s ease;
}

  .pba-chip.show-helper .pba-helper{ opacity:1; }

  
  /* ===== STABLE PER-MESSAGE AURAS (no repaint on theme switch) ===== */

  /* explainer/tooltip brand + left clip prevention */
  .pba-prompts{ padding-left:16px; }
  .pba-chip[data-tooltip]:hover::after, .pba-chip .pba-helper{ background:#27AE60; color:#fff; }
  .pba-chip[data-tooltip]:hover::before{ border-top-color:#27AE60; }

/* ===== MESSAGES ===== */
@keyframes pbaPopIn {
  0%   { transform: scale(.98); opacity: 0 }
  100% { transform: scale(1);   opacity: 1 }
}
.pba-msg.pop .pba-msg-bubble{
  animation: pbaPopIn .18s ease-out;
}

  .pba-chat-body{flex:1;overflow:auto;background:linear-gradient(180deg,#fafcff,#ffffff);padding:12px}
  .pba-msg{display:flex;gap:8px;align-items:flex-start;margin:10px 0}
  .pba-msg-avatar{width:28px;height:28px;border-radius:999px;flex:0 0 28px;overflow:hidden;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.06);position:relative}
  .pba-msg-avatar img{width:100%;height:100%;object-fit:cover;border-radius:999px}

.pba-msg-bubble{
    display:inline-block;
    max-width:100%;             /* stretch wider when space allows */
    width:auto;
    height:auto;
    padding:10px 12px;
    border-radius:12px;
    background:#fff;
    border:1px solid rgba(0,0,0,.06);
    box-shadow:
      inset 0 0 0 0 rgba(0,0,0,0),
      0 2px 6px rgba(0,0,0,.04);
    font-size:14px;
    line-height:1.5;
    white-space:pre-wrap;       /* respect line breaks */
    overflow-wrap:anywhere;     /* wrap long words */
    word-break:break-word;      /* safety */
}

/* Agent messages (left side) */
.pba-msg:not(.me) .pba-msg-bubble {
  margin-left: 8px;   /* small padding from avatar */
}

/* User messages (right side) */
.pba-msg.me .pba-msg-bubble {
  margin-right: 8px;  /* small padding from edge */
}

/* Expanded/fullscreen padding */
.pba-chat.full .pba-msg.me .pba-msg-bubble {
  margin-right: 24px;
}
.pba-chat.full .pba-msg:not(.me) .pba-msg-bubble {
  margin-left: 24px;
}
.pba-chat.full .pba-msg-bubble {
  max-width: 92%;
}

/* Mobile tweaks */
@media (max-width: 600px) {
  .pba-msg.me .pba-msg-bubble {
    margin-right: 12px;
  }
  .pba-msg:not(.me) .pba-msg-bubble {
    margin-left: 12px;
  }
  .pba-chat.full .pba-msg-bubble {
    max-width: 96%;
  }
}

  /* User bubble: brand color + subtle inner aura */
  .pba-msg.me{flex-direction:row-reverse}
  .pba-msg.me .pba-msg-bubble{
    background:var(--pba-user-bg); border-color:var(--pba-user-bg);
    box-shadow:
      inset 0 0 22px color-mix(in srgb, #1F7A4C 10%, transparent),
      0 2px 6px rgba(0,0,0,.04);
  }

 .pba-msg.agent-astra   .pba-msg-bubble{ box-shadow: inset 0 0 24px rgba(124,58,237,.14), 0 2px 6px rgba(0,0,0,.04); }
  .pba-msg.agent-lumina  .pba-msg-bubble{ box-shadow: inset 0 0 24px rgba(255,215,0,.16),   0 2px 6px rgba(0,0,0,.04); }
  .pba-msg.agent-paxion  .pba-msg-bubble{ box-shadow: inset 0 0 24px rgba(56,189,248,.16),   0 2px 6px rgba(0,0,0,.04); }
  .pba-msg.agent-impaxis .pba-msg-bubble{ box-shadow: inset 0 0 24px rgba(34,197,94,.16),    0 2px 6px rgba(0,0,0,.04); }

  /* optional: subtle avatar ring per agent for contrast */
  .pba-msg.agent-astra   .pba-msg-avatar{ box-shadow: 0 0 0 2px rgba(124,58,237,.10), 0 1px 2px rgba(0,0,0,.06); }
  .pba-msg.agent-lumina  .pba-msg-avatar{ box-shadow: 0 0 0 2px rgba(255,215,0,.12),   0 1px 2px rgba(0,0,0,.06); }
  .pba-msg.agent-paxion  .pba-msg-avatar{ box-shadow: 0 0 0 2px rgba(56,189,248,.12),  0 1px 2px rgba(0,0,0,.06); }
  .pba-msg.agent-impaxis .pba-msg-avatar{ box-shadow: 0 0 0 2px rgba(34,197,94,.12),   0 1px 2px rgba(0,0,0,.06); }

  /* ===== COMPOSER ===== */
  .pba-composer{display:flex;gap:8px;padding:10px;border-top:1px solid rgba(0,0,0,.06);background:#fff;position:sticky;bottom:0;z-index:2}
  .pba-input{flex:1;min-height:38px;max-height:96px;padding:8px 10px;border:1px solid rgba(0,0,0,.12);border-radius:10px;resize:none;outline:none;font-size:14px;line-height:1.35;overflow:auto;font-family:"Open Sans",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;}
  .pba-send{height:38px;padding:0 12px;border-radius:10px;background:var(--pba-accent);color:#fff;border:none;cursor:pointer;flex:0 0 auto;align-self:flex-end}
  .pba-send:disabled{opacity:.5;cursor:not-allowed}

  /* ===== EXPAND MODE ===== */
  .pba-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:opacity .18s ease;z-index:99998;}
  .pba-backdrop.show{opacity:1;pointer-events:auto;}
  .pba-chat.is-expanded{inset:auto;left:50%;top:50%;transform:translate(-50%,-50%);right:auto;bottom:auto;width:min(720px, 92vw);height:min(80vh, 760px);max-width:none;z-index:99999;}
  @media (max-width: 767px){.pba-chat.is-expanded{left:0;right:0;top:0;bottom:0;transform:none;width:100vw;max-width:100vw;margin:0;box-sizing:border-box;overflow:hidden;border-radius:0;}}
  html, body { overflow-x: hidden; }

/* ===== EMAIL UNLOCK MODAL ===== */
#pbaUnlockModal {
  position: fixed;
  inset: 0;
  z-index: 100005;
}

.pba-unlock-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.45);
}

.pba-unlock-card {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: min(420px, 92vw);
  background: #fff;
  border-radius: 16px;
  padding: 14px;
  box-shadow: 0 18px 44px rgba(0,0,0,0.28);
  border: 1px solid rgba(0,0,0,0.08);
}

.pba-unlock-title {
  font-weight: 700;
  font-size: 15px;
  margin-bottom: 6px;
}

.pba-unlock-sub {
  font-size: 13px;
  opacity: 0.85;
  margin-bottom: 10px;
}

.pba-unlock-input {
  width: 100%;
  box-sizing: border-box;
  padding: 10px 12px;
  font-size: 14px;
  border-radius: 12px;
  border: 1px solid rgba(0,0,0,0.14);
  outline: none;
}

.pba-unlock-actions {
  display: flex;
  gap: 8px;
  margin-top: 10px;
  flex-wrap: wrap;
}

.pba-unlock-btn {
  padding: 8px 10px;
  font-size: 13px;
  border-radius: 12px;
  border: 1px solid rgba(0,0,0,0.12);
  background: #fff;
  cursor: pointer;
}

.pba-unlock-btn.primary {
  background: var(--pba-accent);
  color: #fff;
  border-color: var(--pba-accent);
}

.pba-unlock-btn.danger {
  color: #b91c1c;
  border-color: rgba(220,38,38,0.25);
}

.pba-unlock-footnote {
  margin-top: 10px;
  font-size: 12px;
  opacity: 0.75;
}
/* ===== /EMAIL UNLOCK MODAL ===== */

  /* ===== SWITCHER PALETTE ===== */
  .pba-switcher{
    position:fixed;right:16px;bottom:96px;display:none;gap:8px;z-index:100001;
    padding:6px;background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.18);
    transition:opacity .18s ease, transform .18s ease;opacity:0;transform:translateY(8px);
    flex-direction:column; /* default vertical */
  }
  .pba-switcher.show{display:flex;opacity:1;transform:translateY(0)}
  .pba-switcher .pba-swatch{width:44px;height:44px;border-radius:999px;background:#fff;border:1px solid rgba(0,0,0,.08);box-shadow:0 6px 16px rgba(0,0,0,.12);display:grid;place-items:center;cursor:pointer;transition:transform .12s ease}
  .pba-switcher .pba-swatch:hover{transform:translateY(-2px)}
  .pba-switcher .pba-swatch img{width:32px;height:32px;border-radius:999px;object-fit:cover}

  /* ===== MOBILE PORTRAIT ===== */
  @media (max-width: 767px) and (orientation: portrait){
    .pba-chat{
      position: fixed;
      left:  max(8px, env(safe-area-inset-left, 0px));
      right: max(8px, env(safe-area-inset-right, 0px));
      bottom: 16px;
      top: auto;
      width: auto;
      max-width: none;
      border-radius: 16px;
      box-sizing: border-box;
    }
    .pba-switcher{
      right: 16px;
      bottom: 96px;
      top: auto;
      flex-direction: column; /* vertical in portrait */
      transform: none;
    }
  }

  /* ===== MOBILE LANDSCAPE ===== */
  @media (max-width: 767px) and (orientation: landscape){
    .pba-chat{
      top: max(8px, env(safe-area-inset-top, 0px));
      right: max(8px, env(safe-area-inset-right, 0px));
      bottom: auto;
      left: auto;
      width:  min(560px, calc(100svw - 16px));
      height: min(520px, calc(100svh - 16px));
      max-width:none; border-radius:12px;
    }
    .pba-stage{ display:none; }
    /* Header: show â˜° only */
    #pbaExpandBtn,#pbaStageToggle,#pbaSwitcherBtn,#pbaPromptsToggle,#pbaClose{ display:none; }
    #pbaHamburger{ display:inline-block; }
    /* Docker horizontal in landscape */
    .pba-switcher{
      top: calc(8px + 44px);
      right: 16px;
      bottom: auto;
      flex-direction: row;
    }
  }

  /* ===== JS-ENFORCED LANDSCAPE OVERRIDES ===== */
  .pba-chat.is-land .pba-stage{ display:none; }
  .pba-chat.is-land #pbaHamburger{ display:inline-block; }
  .pba-chat.is-land #pbaExpandBtn,
  .pba-chat.is-land #pbaStageToggle,
  .pba-chat.is-land #pbaSwitcherBtn,
  .pba-chat.is-land #pbaPromptsToggle,
  .pba-chat.is-land #pbaClose{ display:none; }
</style>

<!-- ===== DOCK ===== -->
<div class="pba-dock">
  <div class="pba-avatar">
    <div class="pba-avatar-btn" id="astraBtn" aria-label="Open assistant" role="button">
      <div class="pba-avatar-face" style="background:none;padding:0;">
        <img src="https://kajabi-storefronts-production.kajabi-cdn.com/kajabi-storefronts-production/file-uploads/themes/2148578038/settings_images/b4bf43e-f2fa-816f-d8d7-dd72f32c5ab_Astra_Sprite_Kajabi_Embed_v1.png" alt="Astra"/>
      </div>
    </div>
  </div>
</div>

<!-- ===== CHAT WINDOW ===== -->
<div class="pba-chat" id="pbaChat" data-pba-chat aria-modal="true" role="dialog" aria-labelledby="pbaChatTitle">
  <div class="pba-chat-header">
    <div class="pba-dot"></div> <span id="pbaChatTitle">Astra</span>
    <div class="pba-header-spacer"></div>

    <!-- Persistent on desktop + portrait -->
    <div class="pba-icon-btn" id="pbaExpandBtn"   title="Expand / Collapse">â¤¢</div>
    <div class="pba-icon-btn" id="pbaStageToggle" title="Show/Hide companion">âœ¨</div>
    <div class="pba-icon-btn" id="pbaSwitcherBtn" title="Switch companion">ðŸ‘¥</div>
    <div class="pba-icon-btn" id="pbaPromptsToggle" title="Show/Hide suggestions">ðŸ’¬</div>
    <div class="pba-icon-btn" id="pbaUnlockBtn" title="Unlock Pro / Premium">ðŸ”“</div>
    <div class="pba-close"    id="pbaClose"       title="Close">Ã—</div>

    <!-- Hamburger (mobile landscape only) -->
    <div class="pba-icon-btn" id="pbaHamburger"   title="Menu">â˜°</div>
  </div>

  <!-- Stage -->
  <div class="pba-stage" id="pbaStage">
    <div id="pbaStageWrap" class="pba-avatar" style="position:relative;display:inline-block;">
      <img id="pbaStageImg" src="https://kajabi-storefronts-production.kajabi-cdn.com/kajabi-storefronts-production/file-uploads/themes/2148578038/settings_images/b4bf43e-f2fa-816f-d8d7-dd72f32c5ab_Astra_Sprite_Kajabi_Embed_v1.png" alt="Astra companion" />
    </div>
  </div>

  <!-- Starter prompts -->
  <div class="pba-prompts" id="pbaPrompts"></div>

  <!-- Seeded intro -->
  <div class="pba-chat-body" id="pbaChatBody" data-pba-messages>
    <div class="pba-msg" data-agent="astra">
      <div class="pba-msg-avatar"><img src="https://kajabi-storefronts-production.kajabi-cdn.com/kajabi-storefronts-production/file-uploads/themes/2148578038/settings_images/f143d1a-af60-47c2-03d2-bdb07302407_Astra_Sprite_Kajabi_Embed_v2.png" alt=""></div>
      <div class="pba-msg-bubble">âœ¨ Hi peacebuilder! Iâ€™m <strong>Astra</strong> â€” your Site Navigator &amp; Course Assistant.<br/>Iâ€™ll guide you to the right lessons and tools. Ask me anything to begin!</div>
    </div>
  </div>

  <!-- Composer -->
  <div class="pba-composer">
    <textarea id="pbaInput" class="pba-input" placeholder="Type a messageâ€¦" data-pba-input rows="1"></textarea>
    <button id="pbaSend" class="pba-send" data-pba-send>Send</button>
  </div>
</div>

<!-- ===== EMAIL UNLOCK MODAL (Phase 1) ===== -->
<div id="pbaUnlockModal" style="display:none;">
  <div class="pba-unlock-backdrop" data-pba-unlock-close></div>

  <div class="pba-unlock-card" role="dialog" aria-modal="true" aria-labelledby="pbaUnlockTitle">
    <div class="pba-unlock-title" id="pbaUnlockTitle">ðŸ”“ Unlock Pro / Premium</div>
    <div class="pba-unlock-sub">Enter your email to unlock your plan features on this device.</div>

    <input id="pbaUnlockEmail" class="pba-unlock-input" type="email"
           placeholder="you@domain.com" autocomplete="email" />

    <div class="pba-unlock-actions">
      <button id="pbaUnlockSave" class="pba-unlock-btn primary">Save</button>
      <button id="pbaUnlockCancel" class="pba-unlock-btn" data-pba-unlock-close>Cancel</button>
      <button id="pbaUnlockClear" class="pba-unlock-btn danger" title="Forget this email on this device">Forget</button>
    </div>

    <div class="pba-unlock-footnote">
      Lite is anonymous by default. Email is optional and only used for feature unlock.
    </div>
  </div>
</div>
<!-- ===== /EMAIL UNLOCK MODAL ===== -->

<script>
/* ===== PBA.handleSend â€” minimal connector to webhook (uses existing PBA.api.url) ===== */
window.PBA = window.PBA || {};
PBA.el = PBA.el || {};
PBA.el.stream = PBA.el.stream || document.querySelector('[data-pba-messages]');

PBA.handleSend = async function(){
  const input = document.getElementById('pbaInput');
  const send  = document.getElementById('pbaSend');
  if (!input || !input.value || !input.value.trim()) return;

  const text = input.value.trim();
  input.value = '';
  // user bubble (uses your restored UI helper DOM shape)
  if (typeof PBA.uiAppend === 'function') {
    PBA.uiAppend('user', text);
  }

  // disable while sending
  if (send) send.setAttribute('disabled','disabled');

  try {
    const res = await fetch(PBA.api?.url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        session_id: (sessionStorage.pba_session_id ||= ('sess_'+Math.random().toString(36).slice(2)+Date.now().toString(36))),
        agent: (window.current || 'astra'),
        message: text,
        page: location.pathname,
        ts: Date.now()
      })
    });
    const data = await res.json();

    if (data && Array.isArray(data.messages)) {
      data.messages.forEach(m => PBA.uiAppend('assistant', m));
    } else if (data && typeof data.reply === 'string') {
      PBA.uiAppend('assistant', data.reply);
    } else {
      PBA.uiAppend('assistant', 'Hmm, I didnâ€™t get a usable reply. Try again?');
    }
  } catch (err) {
    console.error('PBA.handleSend error:', err);
    PBA.uiAppend('assistant', 'Connection issueâ€”please try again.');
  } finally {
    if (send) send.removeAttribute('disabled'); // re-enable
    input.focus();
  }
};
/* ===== END PBA.handleSend ===== */
</script>

<!-- Switcher Palette -->
<div class="pba-switcher" id="pbaSwitcher" style="display:none;">
  <div class="pba-swatch" data-id="astra"  title="Astra">
    <img src="https://kajabi-storefronts-production.kajabi-cdn.com/kajabi-storefronts-production/file-uploads/themes/2148578038/settings_images/f143d1a-af60-47c2-03d2-bdb07302407_Astra_Sprite_Kajabi_Embed_v2.png" alt="">
  </div>
  <div class="pba-swatch" data-id="lumina" title="Lumina">
    <img src="https://kajabi-storefronts-production.kajabi-cdn.com/kajabi-storefronts-production/file-uploads/themes/2148578038/settings_images/0a45e57-7fa3-81c0-3a1f-5db0622787a3_Lumina_Sprite_Kajabi_Embed_v2.png" alt="">
  </div>
  <div class="pba-swatch" data-id="paxion" title="Paxion">
    <img src="https://kajabi-storefronts-production.kajabi-cdn.com/kajabi-storefronts-production/file-uploads/themes/2148578038/settings_images/ecc48b5-efc-61e5-e62-02d34d2a8c3b_Paxion_Sprite_Kajabi_Embed_v1.png" alt="">
  </div>
  <div class="pba-swatch" data-id="impaxis" title="Impaxis">
    <img src="https://kajabi-storefronts-production.kajabi-cdn.com/kajabi-storefronts-production/file-uploads/themes/2148578038/settings_images/8476a4f-4c33-058a-266-18a6d12220a1_Impaxis_Sprite_Kajabi_Embed_v1.png" alt="">
  </div>
</div>

<script>
(function(){
  function ready(fn){ if(document.readyState!=='loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn); } }
  ready(function(){

    /* ===== Public API: avatar mode toggle (no extra UI) ===== */
    window.PBA = window.PBA || {};
    const setUserAvatarMode = (mode)=>{
      const root = document.documentElement;
      const url = (mode==='public')
        ? getComputedStyle(root).getPropertyValue('--pba-user-avatar-public').trim()
        : getComputedStyle(root).getPropertyValue('--pba-user-avatar').trim();
      document.querySelectorAll('.pba-msg.me .pba-msg-avatar img').forEach(img=>{
        const m = url.match(/^url\(["']?(.*?)["']?\)$/);
        img.src = m ? m[1] : img.src;
      });
      root.setAttribute('data-user-avatar-mode', mode);
    };
    window.PBA.setUserAvatarMode = setUserAvatarMode;

    /* Query param toggle: ?userAvatar=public|personal (default = personal) */
    try{
      const params = new URLSearchParams(location.search);
      const ua = params.get('userAvatar');
      if(ua==='public' || ua==='personal'){ setUserAvatarMode(ua); }
      else { setUserAvatarMode('personal'); }
    }catch(e){ setUserAvatarMode('personal'); }

    /* ===== Mobile layout helper ===== */
    function isPhoneLand(){
      return window.matchMedia("(max-width: 767px)").matches &&
             window.matchMedia("(orientation: landscape)").matches;
    }
    function setMobileLayout(){
      const chat = document.getElementById('pbaChat');
      if (!chat) return;
      const isExpanded = chat.classList.contains('is-expanded');
      chat.classList.toggle('is-land', isPhoneLand() && !isExpanded);
    }
    ["resize","orientationchange","visibilitychange"].forEach(evt=>{
      window.addEventListener(evt, setMobileLayout, { passive: true });
    });
    if (window.visualViewport){
      window.visualViewport.addEventListener("resize", setMobileLayout, { passive:true });
    }
    setMobileLayout();

    /* ===== Abilities / Suggestions (labels + descriptions) ===== */
    const abilities = {
      astra: [
        ["Quick Nav","Jump to Lessons or Tools"],
        ["Agent Link","Connect to the Right Agent"],
        ["Learning Pathlight","Illuminate Your Next Learning Step"],
        ["Insight Beacon","Reveal Hidden Truths or Resources"]
      ],
      lumina: [
        ["Clarity Mirror","Reflect Emotions and Gain Insight"],
        ["Calm Current","Restore Calm Through Breathe and Presence"],
        ["Purpose Spark","Find Your Mission-Aligned Idea"],
        ["Soul Signal","Tune Into Deeper Inner Truths"]
      ],
      paxion: [
        ["Common Ground","Discover Shared Interests and Goals"],
        ["Collaborative Negotiation","Facilitate Win-Win Agreements"],
        ["Mediator's Lens","See Issues From All Sides"],
        ["Nonviolent Strategy","Design Peaceful Action Plans"]
      ],
      impaxis: [
        ["Purpose Offering","Clarify Your Aligned Offer Idea"],
        ["Impact Canvas","Map Your Mission-Driven Business Model"],
        ["MVP Builder","Design and Test Your Core Product"],
        ["Lean Launch","Build and Ship Your First Version"]
      ]
    };

    function renderPrompts(id){
      const el = document.getElementById('pbaPrompts'); if(!el) return;
      el.innerHTML = "";
      (abilities[id]||[]).forEach(([label, desc])=>{
        const chip = document.createElement('button');
        chip.className = 'pba-chip';
        chip.textContent = label;
        chip.setAttribute('data-tooltip', desc);
        const helper = document.createElement('span');
        helper.className = 'pba-helper';
        helper.textContent = desc;
        chip.appendChild(helper);
        chip.addEventListener('click', ()=>{
          const input = document.getElementById('pbaInput');
          if (!input) return;
          input.value = label + " â€” " + desc;
          input.dispatchEvent(new Event('input', {bubbles:true}));
          input.focus();
        });
        el.appendChild(chip);
      });
    }

/* ==============================
   PBA::CONFIG  (v1, direct-to-n8n)
   ============================== */
window.PBA = window.PBA || {};

// ðŸ”— Your public n8n webhook (HTTPS)
PBA.api = {
  url: 'https://peacebuilderacademy.app.n8n.cloud/webhook/PBA-companion-router' // <-- replace with your real webhook URL
};

// ðŸŽ¯ Defaults for MVP
PBA.defaults = {
  agent: 'astra',   // starting companion
  tier:  'lite'     // lite path (10/day, FAQ free)
};

// â±ï¸ Basic limits & UI prefs (client-side)
PBA.limits = {
  timeoutMs: 12000,
  maxHistory: 5,     // trim chat history we send
  maxChars: 2000     // input guard client-side
};
PBA.ui = {
  typingDelayMs: 350
};

// ðŸ†” Persist a session_id (per-browser) for quotas/rate limits
PBA.session = {
  key: 'pba_session_id',
  get() {
    try {
      const existing = localStorage.getItem(this.key);
      if (existing) return existing;
      // Prefer crypto-grade UUID where available
      const id = (crypto && crypto.randomUUID)
        ? crypto.randomUUID()
        : ('pba_' + Math.random().toString(36).slice(2) + Date.now().toString(36));
      localStorage.setItem(this.key, id);
      return id;
    } catch (e) {
      // Fallback (no localStorage)
      return ('pba_' + Math.random().toString(36).slice(2) + Date.now().toString(36));
    }
  }
};

/* ===== END PBA::CONFIG ===== */

// ==============================
// PBA::IDENTITY (Phase 1 - Email Unlock)
// ==============================
PBA.identity = {
  key: 'pba.user.email',
  get() {
    try {
      return (localStorage.getItem(this.key) || '').trim();
    } catch (e) {
      return '';
    }
  },
  set(email) {
    try {
      localStorage.setItem(this.key, String(email || '').trim());
    } catch (e) {}
  },
  clear() {
    try {
      localStorage.removeItem(this.key);
    } catch (e) {}
  }
};

// ==============================
// Unlock Modal Wiring
// ==============================
PBA.unlock = {
  open() {
    const modal = document.getElementById('pbaUnlockModal');
    const input = document.getElementById('pbaUnlockEmail');
    if (!modal || !input) return;
    input.value = PBA.identity.get();
    modal.style.display = 'block';
    setTimeout(() => input.focus(), 0);
  },
  close() {
    const modal = document.getElementById('pbaUnlockModal');
    if (modal) modal.style.display = 'none';
  }
};

(function bindUnlockUI(){
  function ready(){
    // Hydrate plan/tier from cache so navigation across pages stays consistent
    try {
      if (typeof pbaReadCachedPlan === 'function') {
        const cached = pbaReadCachedPlan();
        window.PBA_USER_PLAN = (window.PBA_USER_PLAN || cached.user_plan || 'lite');
        window.PBAQuotaBypass = (window.PBA_USER_PLAN !== 'lite');

        PBA.state = PBA.state || {};
        PBA.defaults = PBA.defaults || {};

        PBA.state.user_plan = window.PBA_USER_PLAN;
        PBA.state.tier = cached.tier || window.PBA_USER_PLAN;
        PBA.defaults.tier = cached.tier || window.PBA_USER_PLAN;
      }
    } catch (e) {}

    const openBtn  = document.getElementById('pbaUnlockBtn');
    const saveBtn  = document.getElementById('pbaUnlockSave');
    const clearBtn = document.getElementById('pbaUnlockClear');
    const emailInp = document.getElementById('pbaUnlockEmail');

    if (openBtn) openBtn.addEventListener('click', () => PBA.unlock.open());

    document.querySelectorAll('[data-pba-unlock-close]').forEach(el => {
      el.addEventListener('click', () => PBA.unlock.close());
    });

    if (saveBtn) {
     saveBtn.addEventListener('click', async () => {
  const email = (emailInp?.value || '').trim();
  if (!email || !email.includes('@')) {
    alert('Please enter a valid email.');
    return;
  }

  // Store email locally
  PBA.identity.set(email);

  // Close modal immediately for UX
  PBA.unlock.close();

  // ðŸ” IMPORTANT: refresh plan from n8n
  // This allows paid users to unlock even when Lite composer is locked
  await PBA.refreshPlan(
    (PBA.state && PBA.state.agent) ? PBA.state.agent : 'astra'
  );
});
    }

if (clearBtn) {
  clearBtn.addEventListener('click', async () => {
    // 1) Clear stored identity
    try { PBA.identity.clear(); } catch (e) {}
    if (emailInp) emailInp.value = '';

    // 2) Clear any cached plan + quota session (THIS is what was making Pro â€œstickyâ€)
    try {
      localStorage.removeItem('pba.session.v1');     // quota session store (bypass/cap state)
      localStorage.removeItem('pba.user.plan');      // legacy
      localStorage.removeItem('pba.user_plan');      // legacy
      localStorage.removeItem('pba.user.tier');      // legacy
      localStorage.removeItem('pba.tier');           // legacy
    } catch (e) {}

    // 3) Reset global plan + bypass flags used by quota + send()
    try { window.PBAQuotaBypass = false; } catch (e) {}
    try { window.PBA_USER_PLAN = 'lite'; } catch (e) {}

    // 4) Reset widget defaults/state (so send() stops defaulting to Pro)
    try {
      PBA.state = PBA.state || {};
      PBA.state.user_plan = 'lite';
      PBA.state.tier = 'lite';
      PBA.defaults = PBA.defaults || {};
      PBA.defaults.tier = 'lite';
    } catch (e) {}

    // 5) Relock composer immediately (Lite baseline). Keep it simple + deterministic.
    try {
      const input = document.getElementById('pbaInput');
      const send  = document.getElementById('pbaSend');
      if (input) input.disabled = false; // let quota observer decide after next message
      if (send)  send.disabled = false;
    } catch (e) {}

    // 6) Close modal
    try { PBA.unlock.close(); } catch (e) {}
  });
}

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') PBA.unlock.close();
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ready, { once: true });
  } else {
    ready();
  }
})();

/* ==============================
   PBA::PLAN CACHE (v1)
   - Persists verified plan/tier across pages
   ============================== */
const PBA_PLAN_KEY = 'pba.user.plan.v1';
const PBA_TIER_KEY = 'pba.user.tier.v1';

function pbaReadCachedPlan() {
  try {
    const plan = (localStorage.getItem(PBA_PLAN_KEY) || '').trim().toLowerCase();
    const tier = (localStorage.getItem(PBA_TIER_KEY) || '').trim().toLowerCase();
    const user_plan = plan || 'lite';
    return { user_plan, tier: tier || user_plan };
  } catch (e) {
    return { user_plan: 'lite', tier: 'lite' };
  }
}

function pbaWriteCachedPlan(user_plan, tier) {
  try {
    const p = String(user_plan || 'lite').trim().toLowerCase();
    const t = String(tier || p || 'lite').trim().toLowerCase();
    localStorage.setItem(PBA_PLAN_KEY, p);
    localStorage.setItem(PBA_TIER_KEY, t);
  } catch (e) {}
}

function pbaClearCachedPlan() {
  try {
    localStorage.removeItem(PBA_PLAN_KEY);
    localStorage.removeItem(PBA_TIER_KEY);
  } catch (e) {}
}

/* ==============================
   PBA::SEND  (v1)
   ============================== */

// ==============================
// PBA::PLAN REFRESH (Phase 1)
// Calls n8n once to resolve tier after email unlock.
// ==============================

// ==============================
// PBA::APPLY PLAN (Phase 1)
// Updates local UI/state from a plan_check response.
// ==============================
PBA.applyPlanFromResponse = function(resp) {
  try {
    if (!resp || typeof resp !== 'object') return;

    // Only act on plan_check responses
    if (resp.mode !== 'plan_check') return;

    // Store plan values for this session
    PBA.state = PBA.state || {};
    if (resp.user_plan) PBA.state.user_plan = String(resp.user_plan);

    // Persist resolved plan across pages (same storage as quota logic)
    try {
      const STORAGE_KEY = 'pba.session.v1';
      const cur = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      const plan = String(resp.user_plan || '').toLowerCase() || 'lite';
      const next = Object.assign({}, cur, {
        user_plan: plan,
        tier: plan,
        tier_level: (resp.tier_level !== undefined ? Number(resp.tier_level) : (cur.tier_level ?? 0)),
        should_bypass_quota: (resp.should_bypass_quota === true || resp.is_paid === true || plan === 'pro' || plan === 'premium'),
        is_paid: (resp.is_paid === true || plan === 'pro' || plan === 'premium'),
        daily_quota_limit: (resp.daily_quota_limit !== undefined ? resp.daily_quota_limit : cur.daily_quota_limit),
        plan_updated_at: new Date().toISOString()
      });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(next));
    } catch (e) {}


    // Promote plan to globals so PBA.send stops defaulting to lite
    try { window.PBA_USER_PLAN = String(resp.user_plan || '').toLowerCase(); } catch(e) {}

    try { PBA.defaults = PBA.defaults || {}; PBA.defaults.tier = String(resp.user_plan || '').toLowerCase(); } catch(e) {}

    if (resp.tier_level !== undefined) PBA.state.tier_level = Number(resp.tier_level);

    // Update quota limit (so Lite lock can be lifted)
    if (resp.daily_quota_limit !== undefined) {
      PBA.limits = PBA.limits || {};
      PBA.limits.dailyQuota = Number(resp.daily_quota_limit);
    }

    // If paid (or should bypass), clear any local "locked" UI state
    const toBool = (v) => (v === true || v === 'true');
    const plan = String(resp.user_plan || '').toLowerCase();
    const isPaid =
      toBool(resp.is_paid) ||
      toBool(resp.should_bypass_quota) ||
      plan === 'pro' ||
      plan === 'premium';

    if (isPaid) {
      // Mark bypass so quota observer stops enforcing
      window.PBAQuotaBypass = true;

      // Use the built-in unlock routine (clears cap_reached + reenables composer)
      if (typeof window.PBAQuotaUnlockPro === 'function') {
        window.PBAQuotaUnlockPro();
      }

      // Also directly re-enable the actual DOM elements (IDs in this widget)
      const input = document.getElementById('pbaInput');
      const send  = document.getElementById('pbaSend');
      if (input) input.disabled = false;
      if (send)  send.disabled = false;
    }
  } catch (e) {
    console.warn('applyPlanFromResponse failed', e);
  }
};

PBA.refreshPlan = async function(agent) {
  try {
    // Use the active agent or fallback to Astra
    const a = agent || (PBA.state && PBA.state.agent) || 'astra';

    // Call PBA.send with a special system message.
    // n8n must treat this as "no quota charge" and just return plan/tier.
  const result = await PBA.send({
  agent: a,
  message: '__PLAN_CHECK__'
});

// Apply plan response to unlock UI/state
PBA.applyPlanFromResponse(result);

return result;

  } catch (e) {
    console.warn('refreshPlan failed', e);
    return null;
  }
};


PBA.send = async function ({
  message,
  agent  = PBA.defaults.agent,
  tier   = PBA.defaults.tier,
  history = []
} = {}) {
  // Client-side guardrails
  if (!message || typeof message !== 'string') {
    return { ok: false, error: 'EMPTY_MESSAGE' };
  }
  if (PBA.limits?.maxChars && message.length > PBA.limits.maxChars) {
    message = message.slice(0, PBA.limits.maxChars);
  }

  // Trim history on the client (server still validates)
  const trimmedHistory = Array.isArray(history)
    ? history.slice(-1 * (PBA.limits?.maxHistory ?? 5))
    : [];

  // Decide plan for this send:
  // 1) persisted store (pba.session.v1) â†’ 2) window.PBA_USER_PLAN â†’ 3) passed tier â†’ 4) lite
  let planRaw = tier || 'lite';
  try {
    const s = JSON.parse(localStorage.getItem('pba.session.v1') || '{}');
    if (s && s.user_plan) planRaw = String(s.user_plan);
    else if (typeof window !== 'undefined' && window.PBA_USER_PLAN) planRaw = String(window.PBA_USER_PLAN);
  } catch (e) {
    console?.log?.('[PBA] plan detect error', e);
  }
  const planNormalized = (planRaw || 'lite').toLowerCase();

const payload = {
  agent,
  active_companion: agent, // explicit flag for the router
  tier: planNormalized,     // âœ… FIX: force payload to match persisted plan
  user_plan: planNormalized,
  user_email: (PBA.identity && typeof PBA.identity.get === 'function') ? PBA.identity.get() : '',
  message,
  session_id: PBA.session.get(),
  history: trimmedHistory,
  page: {
    url: location.href,
    ref: document.referrer || ''
  },
  client: {
    ts: new Date().toISOString(),
    ua: navigator.userAgent || '',
    lang: navigator.language || ''
  }
};

  // Timeout helper
  const controller = new AbortController();
  const timeoutMs = PBA.limits?.timeoutMs ?? 12000;
  const t = setTimeout(() => controller.abort('TIMEOUT'), timeoutMs);

  try {
    const res = await fetch(PBA.api.url, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify(payload),
      signal: controller.signal
    });
    clearTimeout(t);

    const contentType = res.headers.get('content-type') || '';
    const isJson = contentType.includes('application/json');
    const data = isJson ? await res.json() : { text: await res.text() };

    if (!res.ok) {
      return {
        ok: false,
        status: res.status,
        error: (data && (data.error || data.message)) || 'REQUEST_FAILED',
        data
      };
    }

    // Expected (flexible) shape from n8n:
    // { reply, citations, usage, ui, meta, quota_exhausted, faq }
    return { ok: true, ...data };
  } catch (err) {
    clearTimeout(t);
    const name = (err && err.name) || '';
    const aborted = name === 'AbortError' || String(err).includes('TIMEOUT');
    return { ok: false, error: aborted ? 'TIMEOUT' : 'NETWORK_ERROR', detail: String(err) };
  }
};
/* ===== END PBA::SEND ===== */

/* ==============================
   PBA::UI helpers  (v2 â€” align with .pba-msg-bubble DOM)
   ============================== */
PBA.history = function(max) {
  const nodes = PBA.el.stream?.querySelectorAll('.pba-msg');
  const arr = [];
  nodes && nodes.forEach(n => {
    const role = n.classList.contains('me') ? 'user' : 'assistant';
    const text = n.querySelector('.pba-msg-bubble')?.textContent || '';
    if (text) arr.push({ role, content: text });
  });
  const limit = max ?? (PBA.limits?.maxHistory || 5);
  return arr.slice(-1 * limit);
};

PBA.uiAppend = function(role, text, opts = {}) {
  const wrap = document.createElement('div');
  if (role === 'user') {
    wrap.className = 'pba-msg me';
    wrap.setAttribute('data-agent','me');
    // user avatar (respects personal/public mode)
    const root = document.documentElement;
    const mode = root.getAttribute('data-user-avatar-mode') || 'personal';
    let avatar = getComputedStyle(root).getPropertyValue('--pba-user-avatar').trim();
    if (mode === 'public') avatar = getComputedStyle(root).getPropertyValue('--pba-user-avatar-public').trim();
    const m = avatar.match(/^url\(["']?(.*?)["']?\)$/);
    const src = m ? m[1] : 'https://i.imgur.com/8Km9tLL.png';
    wrap.innerHTML = `
      <div class="pba-msg-avatar"><img src="${src}" alt="You"></div>
      <div class="pba-msg-bubble"></div>`;
  } else {
    const id = window.current || 'astra';
    const c  = (window.companions && window.companions[id]) || { name:'Astra', img:'' };
    wrap.className = 'pba-msg agent-' + id;
    wrap.setAttribute('data-agent', id);
    wrap.innerHTML = `
      <div class="pba-msg-avatar" title="${c.name}"><img src="${c.img}" alt=""></div>
      <div class="pba-msg-bubble"></div>`;
  }

  const bubble = wrap.querySelector('.pba-msg-bubble');
  bubble.textContent = text || '';

  if (opts.faq === true) {
    const tag = document.createElement('div');
    tag.className = 'pba-subtle';
    tag.textContent = '(Free FAQ Answer)';
    bubble.appendChild(tag);
  }

  PBA.el.stream?.appendChild(wrap);
  PBA.el.stream?.scrollTo({ top: PBA.el.stream.scrollHeight, behavior: 'smooth' });

  // subtle pop animation for new messages
  try { wrap.classList.add('pop'); setTimeout(()=> wrap.classList.remove('pop'), 220); } catch(e){}

  return wrap;
};

PBA.uiTyping = function(show) {
  if (show) {
    if (PBA.el._typing) return PBA.el._typing;
    const t = PBA.uiAppend('assistant', 'typingâ€¦');
    t.classList.add('pba-typing');
    PBA.el._typing = t;
    return t;
  } else {
    if (PBA.el._typing) {
      PBA.el._typing.remove();
      PBA.el._typing = null;
    }
  }
};
/* ===== END PBA::UI helpers ===== */

    /* ===== Elements ===== */

/* ===== Mobile Debug: fetch logger + on-screen panel ===== */
(() => {
  try {
    const titleEl = document.getElementById('pbaChatTitle');
    const chat = document.getElementById('pbaChat');

    // Create a tiny hidden debug panel (only toggled by long-press on title)
    const panel = document.createElement('div');
    panel.id = 'pbaDebug';
    panel.setAttribute('aria-hidden', 'true');
    panel.style.cssText = `
      position: fixed; z-index: 999999; right: 8px; bottom: 8px; max-width: 92vw;
      background: rgba(0,0,0,.85); color: #fff; font: 12px/1.4 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
      border-radius: 10px; padding: 10px 12px; box-shadow: 0 10px 30px rgba(0,0,0,.35);
      display: none; white-space: pre-wrap; word-break: break-word; max-height: 48vh; overflow:auto;
    `;
    panel.innerText = 'PBA Debug â€” hidden.\n(Long-press â€œAstraâ€ title to toggle.)';
    document.body.appendChild(panel);

    let pressTimer;
    if (titleEl){
      titleEl.addEventListener('touchstart', () => {
        pressTimer = setTimeout(() => {
          panel.style.display = (panel.style.display === 'none') ? 'block' : 'none';
        }, 650); // long-press to toggle
      }, {passive:true});
      ['touchend','touchcancel','mouseup','mouseleave'].forEach(ev =>
        titleEl.addEventListener(ev, () => clearTimeout(pressTimer), {passive:true})
      );
    }

    // Append a line to the panel
    const logLine = (msg) => {
      if (!panel) return;
      const ts = new Date().toISOString().split('T')[1].replace('Z','');
      panel.textContent += `\n[${ts}] ${msg}`;
      panel.scrollTop = panel.scrollHeight;
    };

    // Initial environment snapshot
    logLine(`UA=${navigator.userAgent}`);
    logLine(`Viewport=${window.innerWidth}x${window.innerHeight}`);
    logLine(`Location=${location.origin}${location.pathname}`);

    // ---- Fetch wrapper with timeout + response capture ----
    const nativeFetch = window.fetch.bind(window);
    window.fetch = async (input, init = {}) => {
      const url = (typeof input === 'string') ? input : (input && input.url) || '';
      const method = (init && init.method) || 'GET';
      const headers = (init && init.headers) || {};
      const bodyPreview = (() => {
        try {
          if (!init || !init.body) return '';
          if (typeof init.body === 'string') {
            const s = init.body.slice(0, 400);
            return s + (init.body.length > 400 ? 'â€¦(+)' : '');
          }
          return '[non-string body]';
        } catch { return '[body parse error]'; }
      })();

      const ctrl = new AbortController();
      const timeoutMs = 20000; // 20s hard timeout for mobile
      const to = setTimeout(() => ctrl.abort('timeout'), timeoutMs);

      logLine(`â†’ FETCH ${method} ${url}`);
      if (bodyPreview) logLine(`â†’ Body: ${bodyPreview}`);
      try {
        const res = await nativeFetch(input, { ...init, signal: ctrl.signal });
        clearTimeout(to);
        logLine(`â† STATUS ${res.status} (${res.type || 'basic'}) for ${url}`);

        // Try to read small error bodies safely
        let text = '';
        try {
          const clone = res.clone();
          text = await clone.text();
          if (text && text.length > 0) {
            logLine(`â† Body (${Math.min(text.length,400)} chars): ${text.slice(0,400)}${text.length>400?'â€¦(+)':''}`);
          }
        } catch {
          /* ignore */
        }

        // Surface common root causes quickly
        if (res.status === 0) logLine('! Network error (status 0) â€” possible mixed content or CORS.');
        if (res.status === 401 || res.status === 403) logLine('! Auth/Origin blocked â€” check n8n origin/headers allowlist.');
        if (res.status === 413) logLine('! Payload too large â€” reduce body or raise n8n limit.');
        if (res.status === 429) logLine('! Rate limited.');
        if (res.status >= 500) logLine('! Server error (5xx) â€” check n8n logs / Cloudflare / node timeouts.');

        return res;
      } catch (err) {
        clearTimeout(to);
        logLine(`Ã— FETCH ERROR: ${String(err && err.message || err)}`);
        logLine('! Likely timeout/CORS/preflight failure. Check OPTIONS handling and HTTPS.');
        throw err;
      }
    };
  } catch (e) {
    console && console.warn && console.warn('PBA debug bootstrap failed:', e);
  }
})();


/* Cache widget elements */
PBA.el = PBA.el || {};
PBA.el.root    = document.querySelector('[data-pba-chat]');
PBA.el.stream  = document.querySelector('[data-pba-messages]');
PBA.el.input   = document.querySelector('[data-pba-input]');
PBA.el.send    = document.querySelector('[data-pba-send]');

    const btn=document.getElementById('astraBtn');
    const chat=document.getElementById('pbaChat');
    const close=document.getElementById('pbaClose');
    const stage=document.getElementById('pbaStage');

if (stage){
  stage.addEventListener('click', (ev)=>{
    const img  = document.getElementById('pbaStageImg');
    const wrap = document.getElementById('pbaStageWrap');
    if (!img) return;

    const ctx = {
      stageImg: img,
      stageWrap: wrap || stage,
      clickX: ev?.offsetX ?? null,
      clickY: ev?.offsetY ?? null
    };

    const token = drawAnimToken();     // â† pull one from the 6-token bag
    runUniversalAddOn(ctx, token);     // â† run that effect
  });
}

    const toggle=document.getElementById('pbaStageToggle');
    const stageImg=document.getElementById('pbaStageImg');
    const titleEl=document.getElementById('pbaChatTitle');
    const dotEl=document.querySelector('.pba-dot');
    const expandBtn=document.getElementById('pbaExpandBtn');
    const hamburger=document.getElementById('pbaHamburger');
    const promptsEl=document.getElementById('pbaPrompts');
    const promptsToggle=document.getElementById('pbaPromptsToggle');

// bounce helper (true ball bounce, random left/right)
function triggerBounce(el){
  if(!el) return;
  const prevAnim = getComputedStyle(el).animation;
  const dir = Math.random() < 0.5 ? 'pbaBounceLeft' : 'pbaBounceRight';
  el.style.animation = `${dir} .95s cubic-bezier(.28,.84,.42,1)`;
  const onEnd = ()=>{
    el.removeEventListener('animationend', onEnd);
    el.style.animation = (prevAnim && prevAnim !== 'none')
      ? prevAnim
      : 'pbaStageBob 6s ease-in-out infinite, pbaStageGlow 5.5s ease-in-out infinite';
  };
  el.addEventListener('animationend', onEnd, { once:true });
}

// === Retrigger-safe image pop helper ===
function popImageSafely(img, opts){
  const durationMs = (opts && opts.durationMs) || 300;
  const easing     = (opts && opts.easing)     || 'cubic-bezier(.22,.9,.25,1)';
  const prevAnim   = getComputedStyle(img).animation;

  // Cancel any in-flight pop and listeners
  if (img._pbaPopCleanup){ try{ img._pbaPopCleanup(); }catch(e){} }

  // Force-pop inline so it wins cascade; first clear -> reflow
  img.style.animation = 'none';
  void img.offsetWidth;

  // Start pop
  img.style.animation = `pbaStagePop ${durationMs}ms ${easing}`;
  let ended = false;

  const onEnd = ()=>{
    if (ended) return;
    ended = true;
    img.removeEventListener('animationend', onEnd);
    img.style.animation = (prevAnim && prevAnim !== 'none')
      ? prevAnim
      : 'pbaStageBob 6s ease-in-out infinite, pbaStageGlow 5.5s ease-in-out infinite';
    img._pbaPopCleanup = null;
  };

  // Fallback in case animationend is skipped by rapid retriggers
  const fallback = setTimeout(onEnd, durationMs + 40);

  // Store cleanup so a new tap can cancel cleanly
  img._pbaPopCleanup = ()=>{
    clearTimeout(fallback);
    img.removeEventListener('animationend', onEnd);
    onEnd();
  };

  img.addEventListener('animationend', onEnd, { once: true });
}

// === Weighted 6-token bag randomizer ===
// Composition: 2x POP, 2x BOUNCE, 1x SPARKLE, 1x MOVEAWAY
let PBA_ANIM_BAG = [];

function refillAnimBag(){
  PBA_ANIM_BAG = ['pop','pop','bounce','bounce','sparkle','moveaway'];
  // simple Fisherâ€“Yates shuffle
  for (let i=PBA_ANIM_BAG.length-1; i>0; i--){
    const j = Math.floor(Math.random()*(i+1));
    [PBA_ANIM_BAG[i], PBA_ANIM_BAG[j]] = [PBA_ANIM_BAG[j], PBA_ANIM_BAG[i]];
  }
}

function drawAnimToken(){
  if (!PBA_ANIM_BAG.length) refillAnimBag();
  return PBA_ANIM_BAG.pop(); // draw 1 per tap
}

// move-away (random left/right)
function triggerMoveAway(el){
  if(!el) return;
  const prevAnim = getComputedStyle(el).animation;
  const dir = Math.random() < 0.5 ? 'pbaMoveAway' : 'pbaMoveAwayRight';
  el.style.animation = `${dir} .42s cubic-bezier(.3,.85,.4,1)`;
  const onEnd = ()=>{
    el.removeEventListener('animationend', onEnd);
    el.style.animation = (prevAnim && prevAnim !== 'none')
      ? prevAnim
      : 'pbaStageBob 6s ease-in-out infinite, pbaStageGlow 5.5s ease-in-out infinite';
  };
  el.addEventListener('animationend', onEnd, { once:true });
}

// sparkle burst helper
function sparkleBurst(container, x, y, count=12){
  if(!container) return;
  const rect = container.getBoundingClientRect();
  const cx = x ?? rect.width/2;
  const cy = y ?? rect.height/2;

  for(let i=0;i<count;i++){
    const s = document.createElement('div');
    s.className = 'pba-sparkle';
    // center particle (14px â†’ half size = 7px offset)
    s.style.left = (cx - 7) + 'px';
    s.style.top  = (cy - 7) + 'px';

    // wider spread: 60â€“120px at random angle
    const angle = Math.random() * 2 * Math.PI;
    const dist  = 60 + Math.random() * 60;
    const dx = Math.cos(angle) * dist;
    const dy = Math.sin(angle) * dist;
    s.style.setProperty('--dx', dx + 'px');
    s.style.setProperty('--dy', dy + 'px');

    // fireworks colors: aura + gold + white
    const colors = ['var(--pba-aura-color)', '#fffacd', '#ffffff'];
    const col = colors[Math.floor(Math.random() * colors.length)];
    s.style.background = `radial-gradient(circle, #fff 40%, ${col} 100%)`;
    s.style.boxShadow  = `0 0 8px ${col}, 0 0 16px ${col}`;

    container.appendChild(s);
    setTimeout(()=> s.remove(), 1200);
  }
}

function triggerSparkle(el, wrap, x, y){
  if(!wrap) return;
  const rect = wrap.getBoundingClientRect();
  const cx = x ?? rect.width/2;
  const cy = y ?? rect.height/2;

  // 4 bursts: center â†’ left â†’ right â†’ top (staggered, more spaced)
  const bursts = [
    {dx:  0, dy:   0, delay:   0, count: 18},
    {dx:-80, dy:   0, delay: 200, count: 16},
    {dx: 80, dy:   0, delay: 400, count: 16},
    {dx:  0, dy: -80, delay: 600, count: 18}
  ];

  bursts.forEach(b=>{
    setTimeout(()=> sparkleBurst(wrap, cx+b.dx, cy+b.dy, b.count), b.delay);
  });
}

// Route one animation token to its effect
function runUniversalAddOn(ctx, token){
  const img = ctx.stageImg;
  switch(token){
    case 'pop':
      popImageSafely(img, { durationMs: 300, easing: 'cubic-bezier(.22,.9,.25,1)' });
      break;
    case 'bounce':
      triggerBounce(img);
      break;
    case 'sparkle':
  triggerSparkle(ctx.stageImg, ctx.stageWrap, ctx.clickX, ctx.clickY);
  break;
    case 'moveaway':
      triggerMoveAway(img);
      break;
  }
}

    if(!btn||!chat) return;

    /* ===== Open / Close ===== */
    const isOpen=()=>getComputedStyle(chat).display!=='none';
    const openChat=()=>{
      chat.style.display='flex'; setMobileLayout();
      if(stageImg){
        stageImg.style.animation="pbaWiggle 0.8s ease";
        setTimeout(()=>{stageImg.style.animation="pbaStageBob 6s ease-in-out infinite, pbaStageGlow 5.5s ease-in-out infinite";},900);
      }
    };
    const removeBackdrop=()=>{
      const bd=document.querySelector('.pba-backdrop'); if(bd) bd.classList.remove('show');
      const b=document.getElementById('pbaExpandBtn'); if(b) b.textContent='â¤¢';
    };
    const closeChat=()=>{ chat.style.display='none'; removeBackdrop(); };

    btn.onclick=()=>isOpen()?closeChat():openChat();
    if(close) close.onclick=closeChat;
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape'&&isOpen()) closeChat(); });

    /* ===== Stage toggle (âœ¨ always sparkles) ===== */
    if(toggle&&stage){
      let stageVisible=true;
      toggle.textContent="âœ¨";
      toggle.title="Show/Hide companion";
      toggle.onclick=()=>{ stageVisible=!stageVisible; stage.style.display=stageVisible?'flex':'none'; };
    }

    /* ===== Prompts toggle (ðŸ’¬) ===== */
    let promptsVisible = true;
    function setPromptsVisible(v){
      promptsVisible = !!v;
      if (promptsEl) promptsEl.classList.toggle('hidden', !promptsVisible);
    }
    if (promptsToggle){
      promptsToggle.addEventListener('click', ()=> setPromptsVisible(!promptsVisible));
    }

    /* ===== Companions (theme + stage + dot + prompts + intros) ===== */
    const companions={
      astra : { name:'Astra',  img:'https://kajabi-storefronts-production.kajabi-cdn.com/kajabi-storefronts-production/file-uploads/themes/2148578038/settings_images/f143d1a-af60-47c2-03d2-bdb07302407_Astra_Sprite_Kajabi_Embed_v2.png',  dot:'#7C3AED' },
      lumina: { name:'Lumina', img:'https://kajabi-storefronts-production.kajabi-cdn.com/kajabi-storefronts-production/file-uploads/themes/2148578038/settings_images/0a45e57-7fa3-81c0-3a1f-5db0622787a3_Lumina_Sprite_Kajabi_Embed_v2.png', dot:'#FFD700' },
      paxion: { name:'Paxion', img:'https://kajabi-storefronts-production.kajabi-cdn.com/kajabi-storefronts-production/file-uploads/themes/2148578038/settings_images/ecc48b5-efc-61e5-e62-02d34d2a8c3b_Paxion_Sprite_Kajabi_Embed_v1.png', dot:'#38BDF8' },
      impaxis:{ name:'Impaxis',img:'https://kajabi-storefronts-production.kajabi-cdn.com/kajabi-storefronts-production/file-uploads/themes/2148578038/settings_images/8476a4f-4c33-058a-266-18a6d12220a1_Impaxis_Sprite_Kajabi_Embed_v1.png',dot:'#22C55E' }
    };
    window.companions=companions;

    const introCopy = {
      lumina:  "Hi! Iâ€™m Lumina â€” your Inner Peace Guide. I help you with self-development and purpose-alignment.",
      paxion:  "Hello! Iâ€™m Paxion â€” your Peacebuilder Strategist. I help you master negotiation and mediation to turn conflict into collaboration.",
      impaxis: "Hey! Iâ€™m Impaxis â€” your Impact Venture Builder. I help you turn ideas into impact and income."
    };
    const seenIntro = new Set();

    function maybeIntro(id){
      if (!introCopy[id] || seenIntro.has(id)) return;
      appendAgentMessage(introCopy[id], id);
      seenIntro.add(id);
    }

    function setTheme(id){
      const c=companions[id]||companions.astra;
window.current = id;  // lock the active agent for replies
      document.documentElement.setAttribute('data-theme',id);
      const dockImg=document.querySelector('#astraBtn img'); if(dockImg) dockImg.src=c.img;
      const stageImg=document.getElementById('pbaStageImg'); if(stageImg) stageImg.src=c.img;
if(stageImg){
  stageImg.style.animation = "pbaWiggle 0.8s ease";
  setTimeout(()=>{
    stageImg.style.animation = "pbaStageBob 6s ease-in-out infinite, pbaStageGlow 5.5s ease-in-out infinite";
  }, 900);
}
      const titleEl=document.getElementById('pbaChatTitle'); if(titleEl) titleEl.textContent=c.name;
      const dotEl=document.querySelector('.pba-dot'); if(dotEl) dotEl.style.background=c.dot;
      if (id !== 'astra') { maybeIntro(id); }
      renderPrompts(id);
      setPromptsVisible(promptsVisible);

      /* Mobile helper blurbs once per session per companion */
      const key = 'pba_helper_' + id;
      const firstTime = !sessionStorage.getItem(key);
      if (firstTime && 'ontouchstart' in window){
        sessionStorage.setItem(key, '1');
        requestAnimationFrame(()=>{
          document.querySelectorAll('#pbaPrompts .pba-chip').forEach((chip, i)=>{
            setTimeout(()=> chip.classList.add('show-helper'), 80 + i*80);
            setTimeout(()=> chip.classList.remove('show-helper'), 2200 + i*40);
          });
        });
      }
    }
    window.setTheme=setTheme;
    setTheme('astra');

    /* ===== Switcher palette (ðŸ‘¥) ===== */
    (function(){
      const switcherBtn=document.getElementById('pbaSwitcherBtn');
      const switcher=document.getElementById('pbaSwitcher');
      if(switcherBtn&&switcher){
        const toggleSwitcher=()=>{
          const showing=getComputedStyle(switcher).display==='flex';
          switcher.style.display=showing?'none':'flex';
          if(!showing){ switcher.classList.add('show'); } else { switcher.classList.remove('show'); }
        };
        switcherBtn.addEventListener('click',(e)=>{ e.stopPropagation(); toggleSwitcher(); });
        document.addEventListener('click',(e)=>{
          if(!switcher.contains(e.target) && e.target!==switcherBtn){ switcher.style.display='none'; switcher.classList.remove('show'); }
        });
        switcher.addEventListener('click',(e)=>{
          const el=e.target.closest('.pba-swatch'); if(!el) return;
          if(typeof setTheme==='function') setTheme(el.dataset.id);
          switcher.style.display='none'; switcher.classList.remove('show');
        });
      }
    })();

    /* ===== Expand mode (â¤¢ / â¤¡) ===== */
    function ensureBackdrop(){
      let bd=document.querySelector('.pba-backdrop');
      if(!bd){
        bd=document.createElement('div'); bd.className='pba-backdrop'; bd.id='pbaBackdrop';
        document.body.appendChild(bd); bd.addEventListener('click', collapse);
      }
      return bd;
    }
    function expand(){
      const bd=ensureBackdrop(); bd.classList.add('show');
      chat.classList.add('is-expanded'); setMobileLayout();
      const b=document.getElementById('pbaExpandBtn'); if(b) b.textContent='â¤¡';
    }
    function collapse(){
      const bd=document.querySelector('.pba-backdrop'); if(bd) bd.classList.remove('show');
      chat.classList.remove('is-expanded'); setMobileLayout();
      const b=document.getElementById('pbaExpandBtn'); if(b) b.textContent='â¤¢';
    }
    if(expandBtn){
      expandBtn.addEventListener('click',()=>{ chat.classList.contains('is-expanded')?collapse():expand(); });
    }

    /* ===== Hamburger (mobile landscape) â€” minimal menu; known limitation ===== */
    if(hamburger){
      let menuEl=null;
      const buildMenu=()=>{
        if(menuEl) return menuEl;
        menuEl=document.createElement('div');
        menuEl.className='pba-header-menu';
        menuEl.style.cssText='position:absolute; top:46px; right:10px; background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:10px; box-shadow:0 10px 28px rgba(0,0,0,.18); padding:6px; z-index:100002;';
        menuEl.innerHTML=`
          <button class="pba-hmenu-item" data-action="suggestions"  style="display:block;width:100%;padding:8px 10px;text-align:left;background:#fff;border:none;border-radius:8px;cursor:pointer;">Show / Hide Suggestions</button>
          <button class="pba-hmenu-item" data-action="toggleStage"  style="display:block;width:100%;padding:8px 10px;text-align:left;background:#fff;border:none;border-radius:8px;cursor:pointer;">Show / Hide Companion</button>
          <button class="pba-hmenu-item" data-action="switcher"     style="display:block;width:100%;padding:8px 10px;text-align:left;background:#fff;border:none;border-radius:8px;cursor:pointer;">Switch Companion</button>
          <button class="pba-hmenu-item" data-action="expand"       style="display:block;width:100%;padding:8px 10px;text-align:left;background:#fff;border:none;border-radius:8px;cursor:pointer;">Expand / Collapse</button>
          <button class="pba-hmenu-item" data-action="close"        style="display:block;width:100%;padding:8px 10px;text-align:left;background:#fff;border:none;border-radius:8px;cursor:pointer;">Close</button>
        `;
        chat.querySelector('.pba-chat-header').appendChild(menuEl);
        return menuEl;
      };
      hamburger.addEventListener('click',(e)=>{
        e.stopPropagation();
        const m=buildMenu();
        const showing=m.style.display==='block';
        m.style.display=showing?'none':'block';
      });
      document.addEventListener('click',(e)=>{
        if(menuEl && !menuEl.contains(e.target) && e.target!==hamburger) menuEl.style.display='none';
      });
      document.addEventListener('click',(e)=>{
        const b=e.target.closest('.pba-hmenu-item'); if(!b) return;
        const act=b.dataset.action;
        if(act==='suggestions'){ setPromptsVisible(!promptsVisible); }
        if(act==='toggleStage'&&toggle) toggle.click();
        if(act==='switcher'){ const sb=document.getElementById('pbaSwitcherBtn'); if(sb) sb.click(); }
        if(act==='expand'){ const eb=document.getElementById('pbaExpandBtn'); if(eb) eb.click(); }
        if(act==='close'){ const cb=document.getElementById('pbaClose'); if(cb) cb.click(); }
        if(menuEl) menuEl.style.display='none';
      });
    }

/* ===== Composer: Enter=send, Shift+Enter=newline (Aura-aware, DOM-ready) ===== */
(function bindComposer(){
  function init(){
    const pbaInput = document.getElementById('pbaInput');
    const pbaSend  = document.getElementById('pbaSend');
    if (!pbaInput || !pbaSend) return false;

    function resize(){
      pbaInput.style.height = 'auto';
      pbaInput.style.height = Math.min(pbaInput.scrollHeight, 96) + 'px';
    }
    function updateState(){
      const hasText = !!(pbaInput.value && pbaInput.value.trim());
      if (hasText){
        pbaSend.removeAttribute('disabled');
        pbaSend.classList.add('active');   // your aura-themed enabled state
      } else {
        pbaSend.setAttribute('disabled','disabled');
        pbaSend.classList.remove('active');
      }
    }

    // initial UI state
    resize();
    updateState();

    // input events
    pbaInput.addEventListener('input', () => { resize(); updateState(); });
    pbaInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (typeof PBA?.handleSend === 'function') PBA.handleSend();
        // reflect state after handler clears input
        setTimeout(updateState, 0);
      }
    });

    // click send â€” reset listeners by cloning
    const clone = pbaSend.cloneNode(true);
    pbaSend.replaceWith(clone);
    if (PBA && PBA.el) PBA.el.send = clone;  // refresh global reference
    clone.addEventListener('click', (e) => {
      e.preventDefault();
      if (typeof PBA?.handleSend === 'function') PBA.handleSend();
      setTimeout(updateState, 0);
    });

    return true;
  }

  // Bind when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init, { once:true });
  } else {
    init() || document.addEventListener('DOMContentLoaded', init, { once:true });
  }
})();
/* ===== END Composer (Aura-aware, DOM-ready) ===== */

    /* ===== Message helpers â€” per-message avatar lock ===== */
    function appendAgentMessage(text, agentId){
      const container=document.getElementById('pbaChatBody'); if(!container) return;
      const c=companions[agentId]||companions.astra;
      const imgSrc=c.img;
      const msg=document.createElement('div'); msg.className='pba-msg'; msg.dataset.agent=agentId;
      msg.innerHTML=`
        <div class="pba-msg-avatar" title="${c.name}"><img src="${imgSrc}" alt=""></div>
        <div class="pba-msg-bubble"></div>`;
      msg.querySelector('.pba-msg-bubble').textContent=text;
      container.appendChild(msg); try{ msg.classList.add('agent-' + agentId); }catch(e){} container.scrollTop=container.scrollHeight;
    }

    function appendUserMessage(text){
      const container=document.getElementById('pbaChatBody'); if(!container) return;
      const msg=document.createElement('div'); msg.className='pba-msg me'; msg.dataset.agent='me';
      const root = document.documentElement;
      const mode = root.getAttribute('data-user-avatar-mode') || 'personal';
      let avatar = getComputedStyle(root).getPropertyValue('--pba-user-avatar').trim();
      if (mode === 'public') avatar = getComputedStyle(root).getPropertyValue('--pba-user-avatar-public').trim();
      const m = avatar.match(/^url\(["']?(.*?)["']?\)$/);
      const src = m ? m[1] : 'https://i.imgur.com/8Km9tLL.png';
      msg.innerHTML=`
        <div class="pba-msg-avatar"><img src="${src}" alt="You"></div>
        <div class="pba-msg-bubble"></div>`;
      msg.querySelector('.pba-msg-bubble').textContent=text;
      container.appendChild(msg); 
msg.classList.add('pop');                          // animate companion replies only
setTimeout(()=> msg.classList.remove('pop'), 220);
try{ msg.classList.add('agent-' + agentId); }catch(e){} container.scrollTop=container.scrollHeight;
    }

    /* ===== Switch theme on load (Astra) & render prompts ===== */
    window.current='astra';
    renderPrompts('astra');
    setPromptsVisible(true);

    // Retro-tag seed messages for stable styling
    try{ document.querySelectorAll('.pba-msg[data-agent]').forEach(el=>{ const id = el.dataset.agent; if(id){ el.classList.add('agent-'+id); } }); }catch(e){}

  });
})();

/* ==============================
   PBA::Send handler + bindings
   ============================== */
PBA.handleSend = async function() {
  const msg = (PBA.el.input?.value || '').trim();
  if (!msg) return;

  // lock UI
  PBA.el.send?.setAttribute('disabled', '');
  PBA.el.input?.setAttribute('disabled', '');

  // show user bubble
  PBA.uiAppend('user', msg);
  if (PBA.el.input) PBA.el.input.value = '';

  // typingâ€¦
  PBA.uiTyping(true);

  // send to n8n
  let res;

  // use the currently selected companion, fall back to Astra
  const agentId = (window.current && typeof window.current === 'string')
    ? window.current
    : PBA.defaults.agent;

  try {
    res = await PBA.send({
      message: msg,
      agent:  agentId,
      tier:   PBA.defaults.tier,
      history: PBA.history(PBA.limits?.maxHistory)
    });
  } catch (e) {
    res = { ok: false, error: 'NETWORK', detail: String(e) };
  }

  // stop typing + unlock UI
  PBA.uiTyping(false);
  PBA.el.send?.removeAttribute('disabled');
  PBA.el.input?.removeAttribute('disabled');
  PBA.el.input?.focus();

  // render assistant bubble
  if (!res || !res.ok) {
    PBA.uiAppend('assistant', 'Sorryâ€”something went wrong. Please try again.');
    return;
  }

  // --- Plan + quota hints from server (Pro/Premium bypass) ---
  try {
    if (res && typeof PBA === 'object') {
      // Internal state for debugging / introspection
      PBA.state = PBA.state || {};

      if ('user_plan' in res)           PBA.state.user_plan           = res.user_plan;
      if ('tier_level' in res)          PBA.state.tier_level          = res.tier_level;
      if ('should_bypass_quota' in res) PBA.state.should_bypass_quota = res.should_bypass_quota;
      if ('has_quota' in res)           PBA.state.has_quota           = res.has_quota;
      if ('daily_quota_limit' in res)   PBA.state.daily_quota_limit   = res.daily_quota_limit;

      // Normalize booleans (may arrive as true/false or "true"/"false")
      const toBool = (v) => (v === true || v === 'true');
      const shouldBypass = toBool(res.should_bypass_quota);
      const hasQuota =
        (res.has_quota === false || res.has_quota === 'false')
          ? false
          : toBool(res.has_quota);

      // If backend says this user should bypass client quota, flip flag + unlock
      if (shouldBypass || hasQuota === false) {
        window.PBAQuotaBypass = true;
        if (typeof window.PBAQuotaUnlockPro === 'function') {
          window.PBAQuotaUnlockPro();
        }
      }
    }
  } catch (e) {
    console?.log?.('[PBA] plan metadata / quota bypass error', e);
  }

  // res.reply is our agreed field from n8n
  const text = res.reply || (res.response && res.response.reply) || '[no reply]';
  // if later you send a `faq:true` flag from n8n, pass it into opts below
  PBA.uiAppend('assistant', text /* , { faq: res.faq === true } */);
};

// click + Enter (no Shift-Enter)
if (PBA.el.send) {
  PBA.el.send.addEventListener('click', PBA.handleSend);
}
if (PBA.el.input) {
  PBA.el.input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      PBA.handleSend();
    }
  });
}

/* ===== END Bind Events ===== */

</script>

<!-- ===== PBA LITE QUOTA â€” SLICE 1 (Astra-themed heads-up after 7th reply) ===== -->
<script>
(function(){

  // ---------- FLAGS (no behavior change yet) ----------
  const QUOTA_ENABLED       = true;
  const INJECT_AFTER_REPLY  = true;   // keep v9.4 behavior (inject after assistant reply)
  const TEMPLATE_FIRST      = false;  // weâ€™ll keep cloning for now; template may come later

  // ---------- CONFIG ----------
  const STORAGE_KEY   = 'pba.session.v1';
    const CHAT_BODY_SEL = '[data-pba-messages]';   // bind strictly to the live stream container
  const USER_MSG_SEL  = '.pba-msg.me';
  const ASTRA_MSG_SEL = '.pba-msg.agent-astra, .pba-msg[data-agent="astra"]';
  const HEADS_UP_AT   = 7; // show heads-up after the 7th user message

  // Astra-styled quota message
  const HEADS_UP_TEXT = 'âœ¨ Youâ€™re making great progress, peacebuilder! Just a heads-up â€” 3 free messages remain in your Lite session today.';

  // (n9 mini-counter disabled â€” keep n7 heads-up + n10 cap only)
  const MINI_COUNTER_AT   = 999;    // never reached in Lite (10/day)
  const MINI_COUNTER_TEXT = '';     // no mini-counter text
  const CAP_AT            = 10;
  const UPSELL_TEXT       = 'âœ¨ (10/10 free daily messages used)<br/>' + 'ðŸ’« Resolve conflict. Launch your impact business. Earn a living doing good.<br/><br/>' +
    'Pro gives you everything you need to learn faster, build smarter, and grow sustainably â€” with expert support, guided tools, and AI-powered peacebuilder companions by your side.<br/><br/>' +
    'ðŸ”“ Upgrade to Pro and start turning your mission into momentum.'; // later: swap in your upgrade URL

  // ---------- DAILY RESET HELPERS ----------
  function pbaTodayKey(){
    const d = new Date(); // device-local date (MVP)
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }

  function pbaLoadStore(){
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); }
    catch(e){ return {}; }
  }
  function pbaSaveStore(s){
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(s || {})); }
    catch(e){}
  }

  function pbaDailyReset(){
  if (!QUOTA_ENABLED) return;
  const today = pbaTodayKey();
  const s = pbaLoadStore();

  // first-time init
  if (!s.dateKey){
    s.dateKey = today;
    pbaSaveStore(s);
    console.log('[PBA] daily init', today);
    return;
  }

  // new day â†’ reset BOTH top-level and nested sess
  if (s.dateKey !== today){
    const newSess = {
      id: (s.sess && s.sess.id) ? s.sess.id : crypto.randomUUID(),
      freeUsed: 0,
      n7_injected: false,
      n7_pending: false,
      n9_injected: false,
      n9_pending: false,
      cap_reached: false
    };

    const next = {
      dateKey: today,
      sess: newSess
    };

    pbaSaveStore(next);
    enableInputAfterReset();  // the helper we added earlier
    console.log('[PBA] daily reset â†’', today);
  }
}

  // ---------- STORAGE HELPERS ----------
  function readStore(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); } catch { return {}; } }

  function writeStore(o){
    try {
      const cur  = pbaLoadStore();               // keep existing dateKey and any future fields
      const next = Object.assign({}, cur, o || {}); 
      localStorage.setItem(STORAGE_KEY, JSON.stringify(next));
    } catch {}
  }

function ensureSess(){
  let s = pbaLoadStore();
  if (!s.sess) s.sess = {
    id: crypto.randomUUID(),
    freeUsed: 0,
    n7_injected: false,
    n7_pending: false,
    n9_injected: false,
    n9_pending: false,
    cap_reached: false
  };

  // Normalize booleans
  if (typeof s.sess.n7_injected !== 'boolean') s.sess.n7_injected = false;
  if (typeof s.sess.n7_pending  !== 'boolean') s.sess.n7_pending  = false;
  if (typeof s.sess.n9_injected !== 'boolean') s.sess.n9_injected = false;
  if (typeof s.sess.n9_pending  !== 'boolean') s.sess.n9_pending  = false;
  if (typeof s.sess.cap_reached !== 'boolean') s.sess.cap_reached = false;

  return s.sess;
}

  function getFreeUsed(){ const s = ensureSess(); return +s.freeUsed || 0; }
  function setFreeUsed(n){ const s = ensureSess(); s.freeUsed = n; writeStore({ sess: s }); }
  function getInjected7(){ const s = ensureSess(); return !!s.n7_injected; }
  function setInjected7(v){ const s = ensureSess(); s.n7_injected = !!v; writeStore({ sess: s }); }

function getPending7(){ const s = ensureSess(); return !!s.n7_pending; }
function setPending7(v){ const s = ensureSess(); s.n7_pending = !!v; writeStore({ sess: s }); }

function getInjected9(){ const s = ensureSess(); return !!s.n9_injected; }
function setInjected9(v){ const s = ensureSess(); s.n9_injected = !!v; writeStore({ sess: s }); }

function getPending9(){ const s = ensureSess(); return !!s.n9_pending; }
function setPending9(v){ const s = ensureSess(); s.n9_pending = !!v; writeStore({ sess: s }); }

function getCapReached(){ const s = ensureSess(); return !!s.cap_reached; }
function setCapReached(v){ const s = ensureSess(); s.cap_reached = !!v; writeStore({ sess: s }); }

// Inject only if the 7th-threshold was crossed this session and we haven't injected yet
function maybeInjectHeadsUp(){
  if (getPending7() && !getInjected7()){
    renderAstraNotice(HEADS_UP_TEXT);
    setInjected7(true);
    setPending7(false);
  }
}

// Inject only if the 9th-threshold was crossed and we haven't injected yet
function maybeInjectMiniCounter(){
  if (getPending9() && !getInjected9()){
    renderAstraNotice(MINI_COUNTER_TEXT);
    setInjected9(true);
    setPending9(false);
  }
}

// If cap was reached, show upsell once and lock the composer
function maybeInjectCap(){
  if (!getCapReached()) return; // act only when the flag is set

  // If a cap notice already exists, do nothing (prevents loops)
  if (document.querySelector('.pba-msg.quota-notice.cap')) return;

  // Inject Astra upsell and lock composer (widget-only)
  renderAstraNotice(UPSELL_TEXT);

  // Mark this specific notice so future runs see it and skip
  const last = document.querySelector(`${CHAT_BODY_SEL} .pba-msg:last-child`);
  if (last) last.classList.add('quota-notice', 'cap');

  disableInputAtCap();
  console.log('[PBA] cap notice injected once + composer locked');
}

function disableInputAtCap(){
  const chat = document.getElementById('pbaChat');
  if (!chat) return;
  const ta  = chat.querySelector('.pba-composer .pba-input');
  const btn = chat.querySelector('.pba-composer .pba-send');

  // Disable visually and via attributes
  if (ta){ ta.setAttribute('disabled','true'); ta.setAttribute('aria-disabled','true'); }
  if (btn){ btn.setAttribute('disabled','true'); btn.setAttribute('aria-disabled','true'); }

  // Guard: block submit/enter/click even if disabled is ignored
  const blockEvt = (e)=>{
    if (typeof getCapReached === 'function' && getCapReached()){
      e.preventDefault();
      e.stopPropagation();
    }
  };

  // Capture phase so we intercept before handlers
  const composer = chat.querySelector('.pba-composer') || chat;
  composer.addEventListener('submit', blockEvt, true);
  composer.addEventListener('click',  blockEvt, true);
  composer.addEventListener('keydown', (e)=>{
    if (!getCapReached || !getCapReached()) return;
    if (e.key === 'Enter' && !e.shiftKey){ // block Enter-to-send
      e.preventDefault();
      e.stopPropagation();
    }
  }, true);

  console.log('[PBA] cap lock applied');
}

function enableInputAfterReset(){
  const chat = document.getElementById('pbaChat');
  if (!chat) return;
  const composer = chat.querySelector('.pba-composer') || chat;

  // Inputs we might have disabled earlier
  const inputs  = composer.querySelectorAll('textarea, input[type="text"], [contenteditable="true"], .pba-input');
  const senders = composer.querySelectorAll('button, [type="submit"], .pba-send');

  inputs.forEach(el=>{
    // Re-enable contenteditable, inputs, textarea
    if (el.getAttribute && el.getAttribute('contenteditable') === 'true'){
      el.setAttribute('contenteditable','true');
    }
    if ('disabled' in el) el.disabled = false;
    el.setAttribute('aria-disabled','false');
    el.classList.remove('pba-locked');
  });

  senders.forEach(btn=>{
    if ('disabled' in btn) btn.disabled = false;
    btn.setAttribute('aria-disabled','false');
    btn.classList.remove('pba-locked');
  });

  console.log('[PBA] daily reset â†’ composer unlocked');
}

  // ---------- RUNTIME BYPASS FOR PRO/PREMIUM ----------
  // Global flag the app can flip when n8n says "no client quota needed"
  window.PBAQuotaBypass = window.PBAQuotaBypass || false;

  // Helper the widget can call to clear any cap + unlock the composer
  window.PBAQuotaUnlockPro = function(){
    try {
      const sess = ensureSess();
      sess.cap_reached  = false;
      sess.n7_pending   = false;
      sess.n7_injected  = false;
      sess.n9_pending   = false;
      sess.n9_injected  = false;
      writeStore({ sess });
      window.PBAQuotaBypass = true;
      enableInputAfterReset();
      console.log('[PBA] quota bypass enabled for this session');
    } catch (e) {
      console.log('[PBA] quota bypass error', e);
    }
  };

  // ---------- DOM HELPERS ----------
  function chatBody(){ return document.querySelector(CHAT_BODY_SEL) || document.body; }

  // Clone latest Astra bubble so formatting is identical
  function renderAstraNotice(text){
    const container = chatBody(); if (!container) return;
    const latestAstra = container.querySelectorAll(ASTRA_MSG_SEL);
    const tpl = latestAstra[latestAstra.length-1];
    if (!tpl) return; // only inject after Astra has spoken

    const clone = tpl.cloneNode(true);
    clone.classList.remove('me');                // ensure not a user bubble
    clone.setAttribute('data-agent','astra');    // normalize attribute

    // Replace bubble text
    const bubble = clone.querySelector('.pba-msg-bubble') || clone;
    bubble.textContent = text;

    container.appendChild(clone);
    container.scrollTop = container.scrollHeight;
  }

  // ---------- BASELINE RECOUNT ON LOAD ----------
  function recountExistingUserMsgs(){
    const container = chatBody(); if (!container) return false;
    const existing = container.querySelectorAll(USER_MSG_SEL).length;
    const current  = getFreeUsed();
    if (existing > current) setFreeUsed(existing);
    return existing >= current;
  }
  function runRecountWithRetries(){
    let tries = 0, done = false;
    const tick = () => {
      if (done || tries > 10) return;
      tries++;
      done = recountExistingUserMsgs();
      if (!done) setTimeout(tick, 150);
    };
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', tick);
    else tick();
  }

// ---------- OBSERVE NEW MESSAGES ----------
function startObserver(){
  const container = chatBody(); if (!container) return;
  ensureSess();

  const obs = new MutationObserver(muts=>{
    // If a Pro/Premium user is active, skip all quota logic
    if (window.PBAQuotaBypass) return;

    let userAdded = 0;
    let astraAdded = 0;

    for (const m of muts){
      m.addedNodes && m.addedNodes.forEach(node=>{
        if (!(node instanceof HTMLElement)) return;

        // count newly-added user bubbles
        if (node.matches && node.matches(USER_MSG_SEL)) userAdded++;
        if (node.querySelectorAll) userAdded += node.querySelectorAll(USER_MSG_SEL).length;

        // detect newly-added Astra bubbles
        if (node.matches && node.matches(ASTRA_MSG_SEL)) astraAdded++;
        if (node.querySelectorAll) astraAdded += node.querySelectorAll(ASTRA_MSG_SEL).length;
      });
    }

    // 1) Count new user messages and detect threshold crossing
    if (userAdded > 0){
      const prev = getFreeUsed();
      const next = prev + userAdded;
      setFreeUsed(next);

      // Set pending ONLY when we CROSS the threshold this tick
      if (prev < HEADS_UP_AT && next >= HEADS_UP_AT && !getInjected7()){
        setPending7(true);
        // If Astra's reply landed in the same batch, try injection shortly
        setTimeout(maybeInjectHeadsUp, 50);
      }

// m9 pend (mini-counter)
if (prev < MINI_COUNTER_AT && next >= MINI_COUNTER_AT && !getInjected9()){
  setPending9(true);
  setTimeout(maybeInjectMiniCounter, 50);
}

// m10 cap (hard cap)
if (prev < CAP_AT && next >= CAP_AT && !getCapReached()){
  setCapReached(true);
  setTimeout(maybeInjectCap, 10);
}
}


    // 2) If Astra replies in this batch (or the next), attempt injection(s)
if (astraAdded > 0){
  maybeInjectHeadsUp();
  maybeInjectMiniCounter();
  maybeInjectCap();
}
  }); // ðŸ‘ˆ closes the MutationObserver callback

  obs.observe(container, { childList: true, subtree: true });
} 

  // ---------- ASTRA NOTICE HELPER ----------
  function renderAstraNotice(html){
    const stream = document.querySelector(CHAT_BODY_SEL);
    if (!stream) return;

    // Create Astra-stamped bubble
    const wrap = document.createElement('div');
    wrap.className = 'pba-msg agent-astra quota-notice';
    wrap.setAttribute('data-agent','astra');

    // Avatar
    const av = document.createElement('div');
    av.className = 'pba-msg-avatar';
    const img = document.createElement('img');
    img.src = 'https://kajabi-storefronts-production.kajabi-cdn.com/kajabi-storefronts-production/file-uploads/themes/2148578038/settings_images/f143d1a-af60-47c2-03d2-bdb07302407_Astra_Sprite_Kajabi_Embed_v2.png'; 
    img.alt = 'Astra';
    av.appendChild(img);

    // Text
    const text = document.createElement('div');
    text.className = 'pba-msg-bubble pba-msg-text';
    text.innerHTML = html;

    wrap.appendChild(av);
    wrap.appendChild(text);

    // Append to stream
    stream.appendChild(wrap);
    stream.scrollTop = stream.scrollHeight;

    console.log('[PBA] Astra notice injected');
  }

  // ---------- INIT ----------
  // Daily reset (runs once on load)
  pbaDailyReset();

// If cap was already reached earlier today, lock composer on load
if (typeof getCapReached === 'function' && getCapReached()){
  disableInputAtCap();
  // Ensure cap notice is present so the state is clear (inject once)
  if (!document.querySelector('.pba-msg.quota-notice.cap')){
    renderAstraNotice(UPSELL_TEXT);
    const last = document.querySelector(`${CHAT_BODY_SEL} .pba-msg:last-child`);
    if (last) last.classList.add('quota-notice','cap');
  }
}

  runRecountWithRetries();
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', startObserver);
  } else {
    startObserver();
  }
})();

</script>

<!-- ===== /PBA LITE QUOTA â€” SLICE 1 ===== -->

